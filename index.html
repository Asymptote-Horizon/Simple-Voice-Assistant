<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes - Interactive Audio Visualizer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        :root {
        prevBtn    --glass-bg: rgba(15, 15, 25, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --accent-primary: #00d4ff;
            --accent-secondary: #bf40bf;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #000;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(191, 64, 191, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 212, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 50%);
            animation: gradientShift 15s ease infinite;
            z-index: 0;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* Logo */
        .logo {
            position: fixed;
            top: 25px;
            left: 25px;
            z-index: 1000;
            width: 140px;
            height: 50px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 8px 15px;
            box-shadow: var(--glass-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .logo:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px 0 rgba(0, 212, 255, 0.3);
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Controls Panel - Left Side */
        .controls-panel {
            position: fixed;
            left: 25px;
            top: 95px;
            width: 280px;
            max-height: calc(100vh - 125px);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 0;
            box-shadow: var(--glass-shadow);
            z-index: 1000;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .controls-panel.collapsed {
            width: 60px;
            padding: 0;
        }

        .panel-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            transition: background 0.3s;
        }

        .panel-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 2px;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .collapsed .panel-title {
            opacity: 0;
        }

        .toggle-icon {
            width: 24px;
            height: 24px;
            color: var(--text-secondary);
            transition: transform 0.3s;
            flex-shrink: 0;
        }

        .collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 20px;
            max-height: calc(100vh - 220px);
            overflow-y: auto;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .collapsed .panel-content {
            opacity: 0;
            pointer-events: none;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 500;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            transition: all 0.2s;
        }

        .control-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.8);
        }

        .control-group input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        .divider {
            height: 1px;
            background: var(--glass-border);
            margin: 20px 0;
        }

        /* Top Right Controls */
        .top-right-controls {
            position: fixed;
            top: 25px;
            right: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 1000;
        }

        .gender-switch {
            display: flex;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 5px;
            cursor: pointer;
            box-shadow: var(--glass-shadow);
        }

        .gender-option {
            padding: 10px 20px;
            border-radius: 20px;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .gender-option.active { 
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
        }

        .language-select {
            padding: 12px 20px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            outline: none;
            box-shadow: var(--glass-shadow);
            transition: all 0.3s;
        }

        .language-select:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }

        /* Bottom Section */
        .bottom-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 0 25px 25px 25px;
        }

        /* Transcript Box */
        .transcript-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--glass-shadow);
        }

        .transcript-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .transcript-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 500;
        }

        .transcript-controls {
            display: flex;
            gap: 10px;
        }

        .transcript-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .transcript-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--accent-primary);
        }

        .transcript-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 50px;
            max-height: 80px;
            overflow-y: auto;
        }

        /* Log File Panel */
        .logfile-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--glass-shadow);
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 250px;
        }

        .logfile-panel.collapsed {
            max-height: 60px;
        }

        .logfile-header {
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logfile-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .logfile-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .logfile-content {
            padding: 0 20px 20px 20px;
            max-height: 170px;
            overflow-y: auto;
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.8;
            font-family: 'Courier New', monospace;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .collapsed .logfile-content {
            opacity: 0;
            max-height: 0;
            padding: 0;
        }

        /* Chat Icon */
        .chat-icon {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.4);
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .chat-icon:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 40px rgba(0, 212, 255, 0.6);
        }

        .chat-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        /* User Info */
        .user-info {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            min-width: 350px;
            display: none;
        }

        .user-info.show { 
            display: block;
            animation: fadeInScale 0.4s ease;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .user-info h3 { 
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-primary);
            margin-bottom: 25px;
            font-size: 18px;
            letter-spacing: 1px;
        }

        .close-user-info {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            font-size: 18px;
            line-height: 1;
        }

        .close-user-info:hover {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff4444;
            color: #ff4444;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .info-item:last-child { border-bottom: none; }

        .info-label { 
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .info-value { 
            color: var(--text-primary);
            font-size: 14px;
        }

        /* Status Text */
        .status-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            color: var(--accent-primary);
            text-align: center;
            z-index: 100;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            pointer-events: none;
            display: none;
        }

        /* Start Overlay */
        .start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(10px);
            cursor: pointer;
            flex-direction: column;
            gap: 20px;
        }

        .start-overlay.hidden { display: none; }

        .start-hint {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 3px;
            animation: pulse 2s ease-in-out infinite;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .start-subhint {
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            color: var(--text-secondary);
            letter-spacing: 2px;
        }

        /* Mic Indicator */
        .mic-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #ff4444;
            border-radius: 50%;
            margin-left: 10px;
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes blink { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.3; } 
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .controls-panel {
                width: 250px;
                left: 10px;
                top: 85px;
            }
            
            .logo {
                width: 100px;
                height: 40px;
                left: 10px;
                top: 10px;
                padding: 6px 10px;
            }

            .top-right-controls {
                top: 10px;
                right: 10px;
                flex-direction: column;
                gap: 8px;
            }

            .gender-switch {
                font-size: 11px;
            }

            .gender-option {
                padding: 8px 14px;
                font-size: 11px;
            }

            .language-select {
                padding: 10px 15px;
                font-size: 11px;
            }

            .bottom-section {
                padding: 0 10px 10px 10px;
            }

            .transcript-container {
                padding: 15px;
            }

            .transcript-text {
                font-size: 12px;
                max-height: 60px;
            }

            .logfile-panel {
                max-height: 180px;
            }

            .logfile-content {
                max-height: 120px;
                font-size: 10px;
            }

            .chat-icon {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
            }

            .chat-icon svg {
                width: 24px;
                height: 24px;
            }

            .user-info {
                min-width: 280px;
                padding: 25px;
                margin: 0 10px;
            }
        }

        @media (max-width: 480px) {
            .controls-panel {
                width: calc(100vw - 20px);
                left: 10px;
                top: 70px;
            }

            .logo {
                width: 80px;
                height: 35px;
            }

            .panel-content {
                max-height: calc(100vh - 300px);
            }
        }
    </style>
</head>
<body>
    <!-- Start Overlay -->
    <div class="start-overlay" id="startOverlay">
        <div class="start-hint">ECHOES</div>
        <div class="start-subhint">Click anywhere to begin</div>
    </div>

    <!-- 3D Canvas Container -->
    <div id="canvas-container"></div>

    <!-- Logo -->
    <div class="logo">
        <img src="assets/photos/logo3.png" alt="Logo">
    </div>

    <!-- Controls Panel - Left Side -->
    <div class="controls-panel" id="controlsPanel">
        <div class="panel-header" id="controlsToggle">
            <span class="panel-title">Visual Controls</span>
            <svg class="toggle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </div>
        <div class="panel-content">
            <div class="control-group">
                <label>Color</label>
                <input type="color" id="color-picker" value="#00d4ff">
            </div>

            <div class="divider"></div>

            <div class="control-group">
                <label>Bloom Strength: <span id="strength-value">0.4</span></label>
                <input type="range" id="bloom-strength" min="0" max="3" step="0.1" value="0.4">
            </div>

            <div class="control-group">
                <label>Bloom Radius: <span id="radius-value">0.8</span></label>
                <input type="range" id="bloom-radius" min="0" max="1" step="0.05" value="0.8">
            </div>

            <div class="control-group">
                <label>Bloom Threshold: <span id="threshold-value">0.5</span></label>
                <input type="range" id="bloom-threshold" min="0" max="1" step="0.05" value="0.5">
            </div>
        </div>
    </div>

    <!-- Top Right Controls -->
    <div class="top-right-controls">
        <div class="gender-switch" id="genderSwitch">
            <div class="gender-option" data-gender="F">‚ôÄ Female</div>
            <div class="gender-option active" data-gender="M">‚ôÇ Male</div>
        </div>
        <select class="language-select" id="languageSelect">
            <option value="MA">üáÆüá≥ Marathi</option>
            <option value="EN">üá¨üáß English</option>
            <option value="HI">üáÆüá≥ Hindi</option>
            <option value="TL">üáÆüá≥ Telugu</option>
        </select>
    </div>

    <!-- Status Text -->
    <div class="status-text" id="statusText"></div>

    <!-- User Info -->
    <div class="user-info" id="userInfo">
        <button class="close-user-info" id="closeUserInfo">√ó</button>
        <h3>User Profile</h3>
        <div class="info-item">
            <span class="info-label">Name:</span>
            <span class="info-value" id="userName">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">Birth Year:</span>
            <span class="info-value" id="userBirthYear">-</span>
        </div>
    </div>

    <!-- Bottom Section -->
    <div class="bottom-section">
        <!-- Transcript Box -->
        <div class="transcript-container">
            <div class="transcript-header">
                <span class="transcript-label">Transcript</span>
                <div class="transcript-controls">
                    <button class="transcript-btn" id="prevBtn">‚èÆ Prev</button>
                    <button class="transcript-btn" id="nextBtn">Next ‚è≠</button>
                </div>
            </div>
            <div class="transcript-text" id="transcriptText">Waiting...</div>
        </div>

        <!-- Log File Panel -->
        <div class="logfile-panel collapsed" id="logfilePanel">
            <div class="logfile-header" id="logfileToggle">
                <span class="logfile-title">Debug Logs</span>
                <svg class="toggle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div class="logfile-content" id="debugInfo"></div>
        </div>
    </div>

    <!-- Chat Icon -->
    <div class="chat-icon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
    </div>

    <!-- Hidden Audio Player -->
    <audio id="audioPlayer" style="display: none;"></audio>

    <!-- Three.js Import Map -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
        }
    }
    </script>

    <!-- Main Script -->
    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        // ============================================
        // Voice Assistant Variables
        // ============================================
        let currentLanguage = 'MA';
        let currentGender = 'M';
        let currentAudioIndex = 1;
        let isListening = false;
        let recognition = null;
        let userData = { name: 'User', birthYear: '1980' };
        
        const API_KEY = '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';
        const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        
        // DOM Elements
        const audioPlayer = document.getElementById('audioPlayer');
        const statusText = document.getElementById('statusText');
        const transcriptText = document.getElementById('transcriptText');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userBirthYear = document.getElementById('userBirthYear');
        const closeUserInfo = document.getElementById('closeUserInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const genderSwitch = document.getElementById('genderSwitch');
        const languageSelect = document.getElementById('languageSelect');
        const debugInfo = document.getElementById('debugInfo');
        const startOverlay = document.getElementById('startOverlay');
        const controlsPanel = document.getElementById('controlsPanel');
        const controlsToggle = document.getElementById('controlsToggle');
        const logfilePanel = document.getElementById('logfilePanel');
        const logfileToggle = document.getElementById('logfileToggle');

        // ============================================
        // Three.js Scene Setup
        // ============================================
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(
            45,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.set(6, 8, 14);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Vertex Shader
        const vertexShader = `
            uniform float u_time;
            uniform float u_frequency;

            vec3 mod289(vec3 x) {
                return x - floor(x * (1.0 / 289.0)) * 289.0;
            }

            vec4 mod289(vec4 x) {
                return x - floor(x * (1.0 / 289.0)) * 289.0;
            }

            vec4 permute(vec4 x) {
                return mod289(((x*34.0)+10.0)*x);
            }

            vec4 taylorInvSqrt(vec4 r) {
                return 1.79284291400159 - 0.85373472095314 * r;
            }

            vec3 fade(vec3 t) {
                return t*t*t*(t*(t*6.0-15.0)+10.0);
            }

            float pnoise(vec3 P, vec3 rep) {
                vec3 Pi0 = mod(floor(P), rep);
                vec3 Pi1 = mod(Pi0 + vec3(1.0), rep);
                Pi0 = mod289(Pi0);
                Pi1 = mod289(Pi1);
                vec3 Pf0 = fract(P);
                vec3 Pf1 = Pf0 - vec3(1.0);
                vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);
                vec4 iy = vec4(Pi0.yy, Pi1.yy);
                vec4 iz0 = Pi0.zzzz;
                vec4 iz1 = Pi1.zzzz;

                vec4 ixy = permute(permute(ix) + iy);
                vec4 ixy0 = permute(ixy + iz0);
                vec4 ixy1 = permute(ixy + iz1);

                vec4 gx0 = ixy0 * (1.0 / 7.0);
                vec4 gy0 = fract(floor(gx0) * (1.0 / 7.0)) - 0.5;
                gx0 = fract(gx0);
                vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);
                vec4 sz0 = step(gz0, vec4(0.0));
                gx0 -= sz0 * (step(0.0, gx0) - 0.5);
                gy0 -= sz0 * (step(0.0, gy0) - 0.5);

                vec4 gx1 = ixy1 * (1.0 / 7.0);
                vec4 gy1 = fract(floor(gx1) * (1.0 / 7.0)) - 0.5;
                gx1 = fract(gx1);
                vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);
                vec4 sz1 = step(gz1, vec4(0.0));
                gx1 -= sz1 * (step(0.0, gx1) - 0.5);
                gy1 -= sz1 * (step(0.0, gy1) - 0.5);

                vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);
                vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);
                vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);
                vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);
                vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);
                vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);
                vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);
                vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);

                vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));
                g000 *= norm0.x;
                g010 *= norm0.y;
                g100 *= norm0.z;
                g110 *= norm0.w;
                vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));
                g001 *= norm1.x;
                g011 *= norm1.y;
                g101 *= norm1.z;
                g111 *= norm1.w;

                float n000 = dot(g000, Pf0);
                float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));
                float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));
                float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));
                float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));
                float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));
                float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));
                float n111 = dot(g111, Pf1);

                vec3 fade_xyz = fade(Pf0);
                vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);
                vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);
                float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x);
                return 2.2 * n_xyz;
            }

            void main() {
                float noise = 3.0 * pnoise(position + u_time, vec3(10.0));
                float displacement = (u_frequency / 30.0) * (noise / 10.0);
                vec3 newPosition = position + normal * displacement;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
            }
        `;

        // Fragment Shader
        const fragmentShader = `
            uniform float u_red;
            uniform float u_blue;
            uniform float u_green;

            void main() {
                gl_FragColor = vec4(vec3(u_red, u_green, u_blue), 1.0);
            }
        `;

        // Uniforms
        const uniforms = {
            u_time: { value: 0.0 },
            u_frequency: { value: 0.0 },
            u_red: { value: 0.0 },
            u_green: { value: 0.83 },
            u_blue: { value: 1.0 }
        };

        // Material & Geometry
        const mat = new THREE.ShaderMaterial({
            wireframe: true,
            uniforms,
            vertexShader,
            fragmentShader
        });

        const geo = new THREE.IcosahedronGeometry(3, 30);
        const mesh = new THREE.Mesh(geo, mat);
        scene.add(mesh);

        // Post-processing
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(
            new THREE.Vector2(window.innerWidth, window.innerHeight)
        );
        bloomPass.threshold = 0.5;
        bloomPass.strength = 0.4;
        bloomPass.radius = 0.8;
        const outputPass = new OutputPass();

        const bloomComposer = new EffectComposer(renderer);
        bloomComposer.addPass(renderScene);
        bloomComposer.addPass(bloomPass);
        bloomComposer.addPass(outputPass);

        // ============================================
        // FIXED: Audio setup for visualizer
        // Connect HTML audio element to Web Audio API
        // ============================================
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const audioSource = audioContext.createMediaElementSource(audioPlayer);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 64; // Matches the original (32 * 2)
        
        // Connect: HTML Audio Element -> Analyser -> Speakers
        audioSource.connect(analyser);
        analyser.connect(audioContext.destination);

        // Create a data array for frequency analysis
        const frequencyData = new Uint8Array(analyser.frequencyBinCount);

        // Helper function to get average frequency
        function getAverageFrequency() {
            analyser.getByteFrequencyData(frequencyData);
            let sum = 0;
            for (let i = 0; i < frequencyData.length; i++) {
                sum += frequencyData[i];
            }
            return sum / frequencyData.length;
        }

        // Mouse tracking
        let mouseX = 0;
        let mouseY = 0;
        document.addEventListener('mousemove', (e) => {
            const windowHalfX = window.innerWidth / 2;
            const windowHalfY = window.innerHeight / 2;
            mouseX = (e.clientX - windowHalfX) / 100;
            mouseY = (e.clientY - windowHalfY) / 100;
        });

        // Window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            bloomComposer.setSize(window.innerWidth, window.innerHeight);
        });

        // Animation loop
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);

            camera.position.x += (mouseX - camera.position.x) * 0.05;
            camera.position.y += (-mouseY - camera.position.y) * 0.5;
            camera.lookAt(scene.position);

            uniforms.u_time.value = clock.getElapsedTime();
            // FIXED: Use our custom frequency getter
            uniforms.u_frequency.value = getAverageFrequency();

            bloomComposer.render();
        }
        animate();

        // ============================================
        // Voice Assistant Functions
        // ============================================
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = getLanguageCode(currentLanguage);
                
                recognition.onstart = () => {
                    isListening = true;
                    transcriptText.textContent = 'üé§ Listening...';
                };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    transcriptText.textContent = transcript;
                    handleTranscript(transcript);
                };
                recognition.onend = () => { 
                    isListening = false;
                };
            }
        }

        function getLanguageCode(lang) {
            const codes = { 'EN': 'en-US', 'MA': 'mr-IN', 'HI': 'hi-IN', 'TL': 'te-IN' };
            return codes[lang] || 'en-US';
        }

        async function detectLocation() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                const stateLanguageMap = { 
                    'Maharashtra': 'MA', 'MH': 'MA', 
                    'Telangana': 'TL', 'Andhra Pradesh': 'TL' 
                };
                currentLanguage = stateLanguageMap[data.region] || 'MA';
                languageSelect.value = currentLanguage;
            } catch (e) { 
                log('Location detection failed'); 
            }
        }

        function playAudio(index) {
            const audioPath = `assets/audio/${currentLanguage}/${currentLanguage}-0${index}-${currentGender}.mp3`;
            log('Playing: ' + audioPath);
            
            // Resume audio context if suspended (required for autoplay in some browsers)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            audioPlayer.src = audioPath;
            audioPlayer.play().catch(e => { 
                log('Audio error: ' + audioPath + ' - ' + e.message); 
            });
        }

        audioPlayer.onended = () => {
    log(`Audio ${currentAudioIndex} ended`);

    // AUDIO 1 ‚Üí detect language
    if (currentAudioIndex === 1) {
        startListening();
        return;
    }

    // AUDIO 2
    if (currentAudioIndex === 2) {

        // Marathi flow ‚Üí do NOT listen again
        if (currentLanguage === 'MA') {
            return;
        }

        // English / Hindi / Telugu ‚Üí listen for name
        startListening();
        return;
    }

    // No mic after audio 3+
};


        function startListening() {
            if (recognition && !isListening) {
                recognition.lang = getLanguageCode(currentLanguage);
                recognition.start();
            }
        }

        async function handleTranscript(transcript) {
    if (currentAudioIndex === 1) {
        await detectLanguageAndGender(transcript);
        return;
    }

    // Always extract user info ONLY after audio 2
    if (currentAudioIndex === 2) {
        await extractUserInfo(transcript);
    }
}


        async function detectLanguageAndGender(transcript) {
            const systemPrompt = `You will be given a text transcripted from speech recognition, from that determine which language and Voice Gender( Male/female) the user is most likely wanting for conversation English Marathi Hindi or Telugu and reply with that code EN, MA, HI, TL followed by M or F. So if User most likely wants Telugu Male reply with TL-M, or if user wants Hindi, Female reply with HI-F. Do not reply anything else. Current language is "${currentLanguage}"`;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${API_KEY}`,
                        'HTTP-Referer': window.location.origin || 'http://localhost',
                        'X-Title': 'Echoes Audio App'
                    },
                    body: JSON.stringify({
                        model: 'openai/gpt-4o-mini',
                        messages: [
                            { role: 'system', content: systemPrompt }, 
                            { role: 'user', content: transcript }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`API HTTP Error: ${response.status} - ${errorText}`);
                    throw new Error(`Network response was not ok: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.choices?.[0]?.message?.content?.trim() || "";
                log('AI Preference: ' + (aiResponse || "EMPTY RESPONSE"));

                const previousLanguage = currentLanguage;
                const match = aiResponse.match(/(EN|MA|HI|TL)-(M|F)/i);
                if (match) {
                    currentLanguage = match[1].toUpperCase();
                    currentGender = match[2].toUpperCase();
                    languageSelect.value = currentLanguage;
                    updateGenderSwitch(currentGender);
                    log(`Set language to: ${currentLanguage}, gender to: ${currentGender}`);
                    
                    // If language changed, start from audio 2 in new language
                    if (previousLanguage !== currentLanguage) {
                        log('Language changed, restarting from audio 2');
                        setTimeout(() => { 
                            currentAudioIndex = 2; 
                            playAudio(currentAudioIndex); 
                        }, 1500);
                    } else {
                        // Same language, continue to audio 2
                        setTimeout(() => { 
                            currentAudioIndex = 2; 
                            playAudio(currentAudioIndex); 
                        }, 1500);
                    }
                } else {
                    log(`Could not parse AI response: "${aiResponse}"`);
                    setTimeout(() => { 
                        currentAudioIndex = 2; 
                        playAudio(currentAudioIndex); 
                    }, 1500);
                }
            } catch (e) { 
                log('Step 1 Error: ' + e.message);
                setTimeout(() => { 
                    currentAudioIndex = 2; 
                    playAudio(currentAudioIndex); 
                }, 1500);
            }
        }

        async function extractUserInfo(transcript) {
            const systemPrompt = `You are given that text transcript that using voice recognition when the user was asked to tell there name and birth year. Try to figure out from the text what their name and birth year is if nothing conclusive is there default to { "name": "User", "Birthyear" : "1980"}. Make sure you are response contains only this type of text in JSON format nothing more.`;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${API_KEY}`,
                        'HTTP-Referer': window.location.origin || 'http://localhost',
                        'X-Title': 'Echoes Audio App'
                    },
                    body: JSON.stringify({
                        model: 'openai/gpt-4o-mini',
                        messages: [
                            { role: 'system', content: systemPrompt }, 
                            { role: 'user', content: transcript }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`API HTTP Error Step 2: ${response.status} - ${errorText}`);
                    showUserInfoAndContinue();
                    return;
                }

                const data = await response.json();
                const content = data.choices?.[0]?.message?.content || "";
                log('Raw Step 2 Response: ' + content);

                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    try {
                        const parsed = JSON.parse(jsonMatch[0]);
                        userName.textContent = parsed.name || parsed.Name || 'User';
                        userBirthYear.textContent = parsed.Birthyear || parsed.birthYear || parsed.year || '1980';
                        showUserInfoAndContinue();
                        return;
                    } catch (parseError) {
                        log('JSON Parse Error: ' + parseError.message);
                    }
                }
                
                showUserInfoAndContinue();
                
            } catch (e) { 
                log('Step 2 Error: ' + e.message);
                showUserInfoAndContinue(); 
            }
        }

        function showUserInfoAndContinue() {
    userInfo.classList.add('show');

    const timer = setTimeout(() => {
        closeUserInfoImmediate();
        currentAudioIndex = 3;
        playAudio(3);
    }, 5000);

    userInfo.dataset.timer = timer;
}


        function closeUserInfoAndContinue() {
            userInfo.classList.remove('show');
            if (userInfo.dataset.timer) {
                clearTimeout(parseInt(userInfo.dataset.timer));
                delete userInfo.dataset.timer;
            }
            currentAudioIndex = 3;
            playAudio(currentAudioIndex);
        }
         
function closeUserInfoImmediate() {
    userInfo.classList.remove('show');
    if (userInfo.dataset.timer) {
        clearTimeout(Number(userInfo.dataset.timer));
        delete userInfo.dataset.timer;
    }
}




function goToNextAudio(auto = false) {
    // Always close user info if moving forward
    if (userInfo.classList.contains('show')) {
        closeUserInfoImmediate();
    }

    currentAudioIndex++;
    playAudio(currentAudioIndex);
}

 
        function updateGenderSwitch(gender) {
            const options = genderSwitch.querySelectorAll('.gender-option');
            options.forEach(opt => opt.classList.toggle('active', opt.dataset.gender === gender));
        }

        function log(msg) {
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] ${msg}<br>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        // ============================================
        // Event Listeners
        // ============================================

        // Color picker
        document.getElementById('color-picker').addEventListener('input', (e) => {
            const color = e.target.value;
            const r = parseInt(color.substr(1, 2), 16) / 255;
            const g = parseInt(color.substr(3, 2), 16) / 255;
            const b = parseInt(color.substr(5, 2), 16) / 255;
            
            uniforms.u_red.value = r;
            uniforms.u_green.value = g;
            uniforms.u_blue.value = b;
        });

        // Bloom controls
        document.getElementById('bloom-strength').addEventListener('input', (e) => {
            bloomPass.strength = parseFloat(e.target.value);
            document.getElementById('strength-value').textContent = e.target.value;
        });

        document.getElementById('bloom-radius').addEventListener('input', (e) => {
            bloomPass.radius = parseFloat(e.target.value);
            document.getElementById('radius-value').textContent = e.target.value;
        });

        document.getElementById('bloom-threshold').addEventListener('input', (e) => {
            bloomPass.threshold = parseFloat(e.target.value);
            document.getElementById('threshold-value').textContent = e.target.value;
        });

        // Gender switch
        genderSwitch.addEventListener('click', (e) => {
            if (e.target.dataset.gender) {
                currentGender = e.target.dataset.gender;
                updateGenderSwitch(currentGender);
            }
        });

        // Language select
        languageSelect.addEventListener('change', (e) => { 
            currentLanguage = e.target.value; 
        });

        // Navigation buttons
     prevBtn.addEventListener('click', () => { 
    closeUserInfoImmediate();
    if (currentAudioIndex > 1) { 
        currentAudioIndex--; 
        playAudio(currentAudioIndex); 
    } 
});

nextBtn.addEventListener('click', () => { 
    closeUserInfoImmediate();
    if (currentAudioIndex < 6) { 
        currentAudioIndex++; 
        playAudio(currentAudioIndex); 
    } 
});


        // Start overlay - click anywhere to start
        startOverlay.addEventListener('click', () => { 
            startOverlay.classList.add('hidden');
            // Resume audio context on user interaction
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            playAudio(1); 
        });

        // Toggle controls panel
        controlsToggle.addEventListener('click', () => {
            controlsPanel.classList.toggle('collapsed');
        });

        // Toggle logfile panel
        logfileToggle.addEventListener('click', () => {
            logfilePanel.classList.toggle('collapsed');
        });

        // Close user info manually
        closeUserInfo.addEventListener('click', () => {
            closeUserInfoAndContinue();
        });

        // ============================================
        // Initialization
        // ============================================
        async function init() {
            await detectLocation();
            initSpeechRecognition();
            log('System initialized');
        }
        
        init();
    </script>
</body>
</html>
